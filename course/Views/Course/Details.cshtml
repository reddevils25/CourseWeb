@model Course
@{
    List<CourseReview> courseReview = ViewBag.courseReview;
    List<Course> courseRelated = ViewBag.courseRelated;
}
@if (TempData["msg"] != null)
{
    <div class="alert alert-success">
        @TempData["msg"]
    </div>
}

<style>
    #btnEnroll {
        background-color: #ec5252;
        border: none;
        padding: 14px;
        font-size: 20px;
        font-weight: 600;
        border-radius: 8px;
    }

        #btnEnroll:hover {
            background-color: #c44141;
        }
</style>

<main class="main">

    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">Chi tiết khóa học</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a href="index.html">Trang chủ</a></li>
                    <li class="current">Chi tiết khóa học</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->
    <!-- Course Details Section -->
    <section id="course-details" class="course-details section">

        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <div class="row">
                <div class="col-lg-8">

                    <!-- Course Hero -->
                    <div class="course-hero" data-aos="fade-up" data-aos-delay="200">
                        <div class="hero-content">
                            <div class="course-badge">
                                <span class="category">@Model.Category.Name</span>
                                <span class="level">@Model.Level</span>
                            </div>
                            <h1>@Model.Title</h1>
                            <p class="course-subtitle">@Model.Subtitle</p>

                            <div class="instructor-card">
                                <img src="@Model.Instructor.User.Avatar" alt="Instructor" class="instructor-image">
                                <div class="instructor-details">
                                    <h5>Giáo sư @Model.Instructor.User.FullName</h5>
                                    <span>@Model.Instructor.Bio</span>
                                    <div class="instructor-rating">
                                        <i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-half"></i>
                                        <span>@ViewBag.AvgRating.ToString("0.0") @ViewBag.TotalReview</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hero-image">

                            @if (ViewBag.PreviewVideo != null)
                            {
                                @Html.Raw(ViewBag.PreviewVideo)
                            }
                            else
                            {
                                <img src="~/img/default-course.jpg" class="img-fluid" />
                            }

                        </div>

                    </div><!-- End Course Hero -->
                    <!-- Course Navigation Tabs -->
                    <div class="course-nav-tabs" data-aos="fade-up" data-aos-delay="300">
                        <ul class="nav nav-tabs" id="course-detailsCourseTab" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" id="course-detailsoverview-tab" data-bs-toggle="tab" data-bs-target="#course-detailsoverview" type="button" role="tab">
                                    <i class="bi bi-layout-text-window-reverse"></i>
                                    Tổng quan
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="course-detailscurriculum-tab" data-bs-toggle="tab" data-bs-target="#course-detailscurriculum" type="button" role="tab">
                                    <i class="bi bi-list-ul"></i>
                                    Chương trình giảng dạy
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="course-detailsreviews-tab" data-bs-toggle="tab" data-bs-target="#course-detailsreviews" type="button" role="tab">
                                    <i class="bi bi-star"></i>
                                    Đánh giá
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="course-detailsCourseTabContent">

                            <!-- Overview Tab -->
                       @Html.Raw(Model.Description)
                            <!-- Curriculum Tab -->
                            <div class="tab-pane fade" id="course-detailscurriculum" role="tabpanel">

                                <div class="curriculum-overview">
                                    <h4>Chương trình giảng dạy</h4>
                                    <p>@Model.Lessons.Count() bài học</p>
                                </div>

                                <div class="accordion" id="curriculumAccordion">
                                    @foreach (var lesson in Model.Lessons)
                                    {
                                        <div class="accordion-item curriculum-module">
                                            <h2 class="accordion-header" id="heading-@lesson.LessonId">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapse-@lesson.LessonId" aria-expanded="false"
                                                        aria-controls="collapse-@lesson.LessonId">
                                                    <div class="module-info">
                                                        <span class="module-title">@lesson.Title</span>
                                                        <span class="module-meta">@lesson.Duration phút</span>
                                                    </div>
                                                </button>
                                            </h2>

                                            <div id="collapse-@lesson.LessonId" class="accordion-collapse collapse"
                                                 aria-labelledby="heading-@lesson.LessonId" data-bs-parent="#curriculumAccordion">
                                                <div class="accordion-body">
                                                    <div class="lessons-list">
                                                        <div class="lesson mb-3">
                                                            <i class="bi bi-play-circle"></i>
                                                            <span class="lesson-title">@lesson.Title</span>
                                                            <a href="@lesson.VideoUrl" target="_blank" class="btn btn-sm btn-outline-primary float-end">Xem video</a>
                                                        </div>

                                                        @if (lesson.Assignments != null && lesson.Assignments.Any())
                                                        {
                                                            <div class="lesson mt-3">
                                                                <h6><i class="bi bi-file-earmark-text"></i> Bài tập</h6>
                                                                <ul class="list-group">
                                                                    @foreach (var ass in lesson.Assignments)
                                                                    {
                                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                            <span>
                                                                                <strong>@ass.Title</strong>
                                                                                <br />
                                                                                <small>@ass.Description</small>
                                                                            </span>
                                                                            <a asp-controller="Assignments"
                                                                               asp-action="Submit"
                                                                               asp-route-assignmentId="@ass.AssignmentId"
                                                                               class="btn btn-sm btn-success">
                                                                                Làm bài
                                                                            </a>
                                                                        </li>
                                                                    }
                                                                </ul>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <p><em>Không có bài tập cho bài học này.</em></p>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>

                            </div>

                            <!-- Reviews Tab -->
                            <div class="tab-pane fade" id="course-detailsreviews" role="tabpanel">

                                <div class="reviews-summary">
                                    <div class="rating-overview">
                                        <div class="overall-rating">
                                            <<div class="rating-number">@ViewBag.AvgRating.ToString("0.0")</div>
                                            <div class="rating-text">@ViewBag.TotalReview đánh giá</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="reviews-list">

                                    @if (ViewBag.courseReview == null || ViewBag.courseReview.Count == 0)
                                    {
                                        <p>Chưa có đánh giá nào cho khóa học này.</p>
                                    }
                                    else
                                    {
                                        @foreach (var r in ViewBag.courseReview)
                                        {
                                            <div class="review-item">
                                                <div class="reviewer-info">
                                                    <img src="@r.User.Avatar" class="reviewer-avatar" alt="Reviewer" />

                                                    <div class="reviewer-details">
                                                        <h6>@r.User.FullName</h6>

                                                        <div class="review-rating">
                                                            @for (int i = 1; i <= 5; i++)
                                                            {
                                                                if (i <= r.Rating)
                                                                {
                                                                    <i class="bi bi-star-fill"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="bi bi-star"></i>
                                                                }
                                                            }
                                                        </div>
                                                    </div>

                                                    <span class="review-date">
                                                        @r.CreatedAt.ToString("dd/MM/yyyy")
                                                    </span>
                                                </div>

                                                <p class="review-text">@r.Comment</p>
                                            </div>
                                        }
                                    }
                                    @if (Context.Session.GetInt32("UserId") != null)
                                    {
                                        <div class="review-form mb-4">
                                            <h5>Đánh giá khóa học</h5>

                                            <form asp-controller="Course"
                                                  asp-action="AddReview"
                                                  method="post">

                                                <input type="hidden" name="CourseId" value="@Model.CourseId" />

                                                <div class="mb-2">
                                                    <label>Đánh giá sao</label>
                                                    <select name="Rating" class="form-select" required>
                                                        <option value="">-- Chọn --</option>
                                                        <option value="5">⭐⭐⭐⭐⭐ (5)</option>
                                                        <option value="4">⭐⭐⭐⭐ (4)</option>
                                                        <option value="3">⭐⭐⭐ (3)</option>
                                                        <option value="2">⭐⭐ (2)</option>
                                                        <option value="1">⭐ (1)</option>
                                                    </select>
                                                </div>

                                                <div class="mb-2">
                                                    <label>Nhận xét</label>
                                                    <textarea name="Comment"
                                                              class="form-control"
                                                              rows="3"
                                                              required></textarea>
                                                </div>

                                                <button type="submit" class="btn btn-primary">
                                                    Gửi đánh giá
                                                </button>
                                            </form>
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted">
                                            Vui lòng <a href="/Account/Login">đăng nhập</a> để đánh giá khóa học.
                                        </p>
                                    }

                                </div>


                            </div><!-- End Reviews Tab -->

                        </div>
                    </div><!-- End Course Navigation Tabs -->

                </div>

                <div class="col-lg-4">

                    <!-- Enrollment Card -->
                    <div class="enrollment-card" data-aos="fade-up" data-aos-delay="200">

                        <div class="card-header">
                            <div class="price-display">
                                <span class="current-price">@Model.Price $</span>
                            </div>
                            <div class="enrollment-count">
                                <i class="bi bi-people"></i>
                                <span>@Model.EnrollCount Sinh viên đăng ký</span>
                            </div>
                        </div>

                        <div class="card-body">
                            <div class="course-highlights">
                                <div class="highlight-item">
                                    <i class="bi bi-trophy"></i>
                                    @if (Model.HasCertificate == true)
                                    {
                                        <span>Có chứng chỉ</span>
                                    }
                                    else
                                    {
                                        <span>Không có chứng chỉ</span>
                                    }

                                </div>
                                <div class="highlight-item">
                                    <i class="bi bi-clock-history"></i>
                                    <span>Nội dung 45 giờ</span>
                                </div>
                                <div class="highlight-item">
                                    <i class="bi bi-download"></i>
                                    <span>Tài nguyên có thể tải xuống</span>
                                </div>
                                <div class="highlight-item">
                                    <i class="bi bi-infinity"></i>
                                    <span>Truy cập trọn đời</span>
                                </div>
                                <div class="highlight-item">
                                    <i class="bi bi-phone"></i>
                                    <span>Truy cập di động</span>
                                </div>
                            </div>

                            <div class="action-buttons">

                                @if (ViewBag.IsEnrolled == true)
                                {
                                    <a asp-controller="Course"
                                       asp-action="Learn"
                                       asp-route-id="@Model.CourseId"
                                       class="btn btn-success w-100 mb-2">
                                        <i class="bi bi-play-circle"></i> Vào học
                                    </a>
                                }
                                else
                                {
                                    <button id="btnEnroll"
                                            data-course="@Model.CourseId"
                                            data-price="@Model.Price"
                                            class="btn-primary w-100 mb-2">
                                        @(Model.Price > 0 ? "Mua khóa học" : "Đăng ký miễn phí")
                                    </button>
                                }

                                <div id="notifyBox" class="alert d-none mt-2"></div>

                                <button class="btn-secondary w-100 mt-2">
                                    Thêm vào danh sách mong muốn
                                </button>

                            </div>


                            <div class="guarantee">
                                <i class="bi bi-shield-check"></i>
                                <span>Đảm bảo hoàn tiền trong 30 ngày</span>
                            </div>
                        </div>

                    </div><!-- End Enrollment Card -->
                    <!-- Course Details -->
                    <div class="course-details-card" data-aos="fade-up" data-aos-delay="300">
                        <h4>Course Details</h4>

                        <div class="detail-grid">
                            <div class="detail-row">
                                <span class="detail-label">Duration</span>
                                <span class="detail-value">16 weeks</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Skill Level</span>
                                <span class="detail-value">Intermediate</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Language</span>
                                <span class="detail-value">English</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Quizzes</span>
                                <span class="detail-value">24</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Assignments</span>
                                <span class="detail-value">8 projects</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Updated</span>
                                <span class="detail-value">December 2024</span>
                            </div>
                        </div>
                    </div><!-- End Course Details -->
                    <!-- Share Course -->
                    <div class="share-course-card" data-aos="fade-up" data-aos-delay="400">
                        <h4>Share This Course</h4>
                        <div class="social-links">
                            <a href="#" class="social-link facebook">
                                <i class="bi bi-facebook"></i>
                            </a>
                            <a href="#" class="social-link twitter">
                                <i class="bi bi-twitter"></i>
                            </a>
                            <a href="#" class="social-link linkedin">
                                <i class="bi bi-linkedin"></i>
                            </a>
                            <a href="#" class="social-link email">
                                <i class="bi bi-envelope"></i>
                            </a>
                        </div>
                    </div><!-- End Share Course -->

                </div>

            </div>

        </div>

    </section><!-- /Course Details Section -->

</main>
<script>
    document.getElementById("btnEnroll").addEventListener("click", function () {

        const courseId = this.dataset.course;
        const price = parseFloat(this.dataset.price);
        const notifyBox = document.getElementById("notifyBox");

  
        if (price > 0) {
            window.location.href = "/Payment/Checkout?courseId=" + courseId;
            return;
        }


        fetch("/Enrollment/Enroll?courseId=" + courseId, {
            method: "POST"
        })
        .then(res => res.json())
        .then(data => {
            notifyBox.className = "alert alert-info";
            notifyBox.innerText = data.message;
            notifyBox.classList.remove("d-none");

            setTimeout(() => {
                notifyBox.classList.add("d-none");
            }, 2500);
        });
    });
</script>
