@{
    ViewData["Title"] = "Thống kê";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<style>
    .stat-card {
        border-radius: 10px;
        padding: 20px;
        color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }

        .stat-card:hover {
            transform: translateY(-5px);
        }

    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filter-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .growth-positive {
        color: #28a745;
        font-weight: bold;
    }

    .growth-negative {
        color: #dc3545;
        font-weight: bold;
    }

    .badge-custom {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
</style>

<div class="content" style="margin-left:150px;">
    <div class="container-fluid pt-4 px-4" style="width:105%; padding-bottom:100px;">

        <!-- TITLE -->
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h2 class="text-primary">📊 Dashboard Thống Kê Nâng Cao</h2>
            <small class="text-muted">Cập nhật: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</small>
        </div>

        <!-- ========== Phần lọc ========== -->
        <div class="filter-card">
            <form method="get" class="row g-3 text-white">
                <div class="col-md-3">
                    <label class="form-label"><strong>📅 Khoảng thời gian</strong></label>
                    <select name="timeRange" class="form-select" onchange="toggleCustomDate(this.value)">
                        <option value="all" selected="@(ViewBag.TimeRange == "all" ? "selected" : null)">Tất cả</option>
                        <option value="today" selected="@(ViewBag.TimeRange == "today" ? "selected" : null)">Hôm nay</option>
                        <option value="week" selected="@(ViewBag.TimeRange == "week" ? "selected" : null)">7 ngày qua</option>
                        <option value="month" selected="@(ViewBag.TimeRange == "month" ? "selected" : null)">30 ngày qua</option>
                        <option value="year" selected="@(ViewBag.TimeRange == "year" ? "selected" : null)">Năm qua</option>
                        <option value="custom" selected="@(ViewBag.TimeRange == "custom" ? "selected" : null)">Tùy chỉnh</option>

                    </select>
                </div>

                <div class="col-md-2" id="startDateDiv" style="display: @(ViewBag.TimeRange == "custom" ? "block" : "none")">
                    <label class="form-label"><strong>Từ ngày</strong></label>
                    <input type="date" name="startDate" class="form-control" value="@ViewBag.StartDate">
                </div>

                <div class="col-md-2" id="endDateDiv" style="display: @(ViewBag.TimeRange == "custom" ? "block" : "none")">
                    <label class="form-label"><strong>Đến ngày</strong></label>
                    <input type="date" name="endDate" class="form-control" value="@ViewBag.EndDate">
                </div>

                <div class="col-md-2">
                    <label class="form-label"><strong>📚 Danh mục</strong></label>
                    <select name="categoryId" class="form-select">
                        <option value="">Tất cả</option>
                        @foreach (var cat in ViewBag.Categories)
                        {
                            <option value="@cat.CategoryId" selected="@(ViewBag.SelectedCategory == cat.CategoryId ? "selected" : null)">
                                @cat.Name
                            </option>

                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label"><strong>🎯 Cấp độ</strong></label>
                    <select name="level" class="form-select">
                        <option value="">Tất cả</option>
                        @foreach (var lv in ViewBag.Levels)
                        {
                            <option value="@lv" selected="@(ViewBag.SelectedLevel == lv ? "selected" : null)">
                                @(lv == "Beginner" ? "Cơ bản" : lv == "Intermediate" ? "Trung cấp" : "Nâng cao")
                            </option>

                        }
                    </select>
                </div>

                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-light w-100">
                        <i class="fas fa-filter"></i> Lọc
                    </button>
                </div>
            </form>
        </div>

        <!-- ========== KPI CARDS WITH GROWTH ========== -->
        <div class="row g-3 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">@ViewBag.TotalCourses</h4>
                            <small>Tổng khóa học</small>
                        </div>
                        <i class="fas fa-book fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">@ViewBag.TotalStudents</h4>
                            <small>Học viên</small>
                        </div>
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">@ViewBag.TotalEnrollments</h4>
                            <small>Lượt đăng ký</small>
                            @if (ViewBag.EnrollmentGrowth != 0)
                            {
                                <div class="mt-1">
                                    <span class="badge @(ViewBag.EnrollmentGrowth > 0 ? "bg-success" : "bg-danger")">
                                        @(ViewBag.EnrollmentGrowth > 0 ? "↑" : "↓") @Math.Abs(ViewBag.EnrollmentGrowth)%
                                    </span>
                                </div>
                            }
                        </div>
                        <i class="fas fa-user-plus fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">@ViewBag.TotalRevenue?.ToString("N0")</h4>
                            <small>Doanh thu (VNĐ)</small>
                            @if (ViewBag.RevenueGrowth != 0)
                            {
                                <div class="mt-1">
                                    <span class="badge @(ViewBag.RevenueGrowth > 0 ? "bg-success" : "bg-danger")">
                                        @(ViewBag.RevenueGrowth > 0 ? "↑" : "↓") @Math.Abs(ViewBag.RevenueGrowth)%
                                    </span>
                                </div>
                            }
                        </div>
                        <i class="fas fa-dollar-sign fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== ADDITIONAL METRICS ========== -->
        <div class="row g-3 mb-4">
            <div class="col-lg-2 col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h5 class="mb-0 text-dark">@ViewBag.AverageRating?.ToString("F1") ⭐</h5>
                    <small class="text-dark">Đánh giá TB</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    <h5 class="mb-0">@ViewBag.PaymentStats.Paid</h5>
                    <small>Đã thanh toán</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <h5 class="mb-0 text-dark">@ViewBag.PaymentStats.ConversionRate%</h5>
                    <small class="text-dark">Tỷ lệ chuyển đổi</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%);">
                    <h5 class="mb-0">@ViewBag.StudentRetention.ActiveStudents</h5>
                    <small>HV hoạt động (30d)</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <h5 class="mb-0 text-dark">@ViewBag.StudentRetention.RetentionRate%</h5>
                    <small class="text-dark">Tỷ lệ quay lại</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%);">
                    <h5 class="mb-0 text-dark">@ViewBag.CompletionStats.AvgProgress?.ToString("F1")%</h5>
                    <small class="text-dark">Tiến độ TB</small>
                </div>
            </div>
        </div>

        <!-- ========== DAILY TRENDS (30 days) ========== -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="text-center mb-3">📈 Đăng ký theo ngày (30 ngày gần nhất)</h5>
                    <canvas id="dailyEnrollmentChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="text-center mb-3">💰 Doanh thu theo ngày (30 ngày gần nhất)</h5>
                    <canvas id="dailyRevenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ========== MONTHLY TRENDS ========== -->
        <div class="row g-4 mb-4">
            <div class="col-lg-12">
                <div class="chart-container">
                    <h5 class="text-center mb-3">📊 Xu hướng theo tháng (12 tháng)</h5>
                    <canvas id="monthlyTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ========== HOURLY & DAY OF WEEK ========== -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="text-center mb-3">🕐 Đăng ký theo giờ (Hôm nay)</h5>
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="text-center mb-3">📅 Đăng ký theo ngày trong tuần</h5>
                    <canvas id="dayOfWeekChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ========== CATEGORY & PRICE RANGE ========== -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="text-center mb-3">📚 Phân tích theo Danh mục</h5>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="text-center mb-3">💵 Phân bố theo Giá</h5>
                    <canvas id="priceRangeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ========== TOP INSTRUCTORS ========== -->
        <div class="chart-container mb-4">
            <h5 class="mb-3">👨‍🏫 Top 10 Giảng viên Xuất sắc</h5>
            <div class="table-responsive">
                <table class="table table-hover table-bordered">
                    <thead class="table-info">
                        <tr>
                            <th>#</th>
                            <th>Giảng viên</th>
                            <th>Số khóa học</th>
                            <th>Tổng học viên</th>
                            <th>Đánh giá TB</th>
                            <th>Doanh thu</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int rank = 1;
                            foreach (var instructor in ViewBag.TopInstructors)
                            {
                                <tr>
                                    <td>@rank++</td>
                                    <td><strong>@instructor.InstructorName</strong></td>
                                    <td>@instructor.TotalCourses</td>
                                    <td><span class="badge bg-primary badge-custom">@instructor.TotalEnrollments</span></td>
                                    <td>@instructor.AvgRating.ToString("F1") ⭐</td>
                                    <td><strong class="text-success">@instructor.TotalRevenue.ToString("N0") VNĐ</strong></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== TOP COURSES ========== -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">🔥 Top 10 Khóa học Phổ biến</h5>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Khóa học</th>
                                    <th>Học viên</th>
                                    <th>Đánh giá</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    rank = 1;
                                    foreach (var course in ViewBag.TopCoursesByEnroll)
                                    {
                                        <tr>
                                            <td>@rank++</td>
                                            <td>
                                                <strong>@course.Title</strong>
                                                <br><small class="text-muted">@course.InstructorName</small>
                                            </td>
                                            <td><span class="badge bg-primary">@course.EnrollCount</span></td>
                                            <td>@course.Rating?.ToString("F1") ⭐</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">💎 Top 10 Khóa học Doanh thu cao</h5>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-success">
                                <tr>
                                    <th>#</th>
                                    <th>Khóa học</th>
                                    <th>Giá</th>
                                    <th>Doanh thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    rank = 1;
                                    foreach (var course in ViewBag.TopCoursesByRevenue)
                                    {
                                        <tr>
                                            <td>@rank++</td>
                                            <td>
                                                <strong>@course.Title</strong>
                                                <br><small class="text-muted">@course.InstructorName</small>
                                            </td>
                                            <td>@course.Price?.ToString("N0")</td>
                                            <td><strong class="text-success">@course.Revenue?.ToString("N0")</strong></td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== RECENT ENROLLMENTS ========== -->
        <div class="chart-container">
            <h5 class="mb-3">🕐 Đăng ký gần đây</h5>
            <div class="table-responsive">
                <table class="table table-hover table-bordered">
                    <thead class="table-warning">
                        <tr>
                            <th>#</th>
                            <th>Học viên</th>
                            <th>Khóa học</th>
                            <th>Ngày đăng ký</th>
                            <th>Số tiền</th>
                            <th>Trạng thái</th>
                            <th>Tiến độ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            rank = 1;
                            foreach (var item in ViewBag.RecentEnrollments)
                            {
                                <tr>
                                    <td>@rank++</td>
                                    <td>@item.StudentName</td>
                                    <td>@item.CourseName</td>
                                    <td>@item.EnrollDate.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@item.Amount?.ToString("N0") VNĐ</td>
                                    <td>
                                        @if (item.IsPaid)
                                        {
                                            <span class="badge bg-success">Đã thanh toán</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Chưa thanh toán</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar @(item.Progress >= 100 ? "bg-success" : item.Progress > 0 ? "bg-primary" : "bg-secondary")"
                                                 style="width: @item.Progress%">
                                                @item.Progress%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

<script>
    function toggleCustomDate(value) {
        const startDiv = document.getElementById('startDateDiv');
        const endDiv = document.getElementById('endDateDiv');
        if (value === 'custom') {
            startDiv.style.display = 'block';
            endDiv.style.display = 'block';
        } else {
            startDiv.style.display = 'none';
            endDiv.style.display = 'none';
        }
    }

    // ========== DAILY ENROLLMENT CHART ==========
    new Chart(document.getElementById('dailyEnrollmentChart'), {
        type: 'line',
        data: {
            labels: @Html.Raw(Json.Serialize(ViewBag.DailyLabels)),
            datasets: [{
                label: 'Số đăng ký',
                data: @Html.Raw(Json.Serialize(ViewBag.DailyEnrollments)),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });

    // ========== DAILY REVENUE CHART ==========
    new Chart(document.getElementById('dailyRevenueChart'), {
        type: 'line',
        data: {
            labels: @Html.Raw(Json.Serialize(ViewBag.DailyLabels)),
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: @Html.Raw(Json.Serialize(ViewBag.DailyRevenue)),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });

    // ========== MONTHLY TREND CHART ==========
    new Chart(document.getElementById('monthlyTrendChart'), {
        type: 'line',
        data: {
            labels: @Html.Raw(Json.Serialize(ViewBag.MonthlyLabels)),
            datasets: [
                {
                    label: 'Đăng ký',
                    data: @Html.Raw(Json.Serialize(ViewBag.MonthlyEnrollments)),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    yAxisID: 'y'
                },
                {
                    label: 'Doanh thu (VNĐ)',
                    data: @Html.Raw(Json.Serialize(ViewBag.MonthlyRevenue)),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
                y: { type: 'linear', position: 'left' },
                y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } }
            }
        }
    });

    // ========== HOURLY CHART ==========
    new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: @Html.Raw(Json.Serialize(ViewBag.HourlyLabels)),
            datasets: [{
                label: 'Số đăng ký',
                data: @Html.Raw(Json.Serialize(ViewBag.HourlyEnrollments)),
                backgroundColor: 'rgba(54, 162, 235, 0.8)'
            }]
        },
        options: { responsive: true }
    });

    // ========== DAY OF WEEK CHART ==========
    new Chart(document.getElementById('dayOfWeekChart'), {
        type: 'bar',
        data: {
            labels: @Html.Raw(Json.Serialize(ViewBag.DayOfWeekLabels)),
            datasets: [{
                label: 'Số đăng ký',
                data: @Html.Raw(Json.Serialize(ViewBag.DayOfWeekEnrollments)),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(199, 199, 199, 0.8)'
                ]
            }]
        },
        options: { responsive: true }
    });

    // ========== CATEGORY CHART ==========
    new Chart(document.getElementById('categoryChart'), {
        type: 'bar',
        data: {
            labels: @Html.Raw(Json.Serialize(ViewBag.CategoryLabels)),
            datasets: [{
                label: 'Số lượt đăng ký',
                data: @Html.Raw(Json.Serialize(ViewBag.CategoryEnrollments)),
                backgroundColor: 'rgba(75, 192, 192, 0.8)'
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y'
        }
    });

    // ========== PRICE RANGE CHART ==========
    new Chart(document.getElementById('priceRangeChart'), {
        type: 'doughnut',
        data: {
            labels: @Html.Raw(Json.Serialize(ViewBag.PriceRangeLabels)),
            datasets: [{
                data: @Html.Raw(Json.Serialize(ViewBag.PriceRangeCounts)),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ]
            }]
        },
        options: { responsive: true }
    });
</script>